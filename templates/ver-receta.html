{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ver-receta.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-categoria.css') }}">
{% endblock %}

{% block title %} {{ receta.nombre }} {% endblock %}

{% block content %}
<main>
    <div class="recipe-container">
        
        <div class="recipe-header">
            <h1>{{ receta.nombre }}</h1>
            <div class="recipe-meta">
                <span class="meta-item">
                    <i class='bx bxs-user-circle'></i> {{ receta.usuario.nombre_apellido }}
                </span>
                <span class="meta-item">
                    <i class='bx bxs-category'></i> {{ receta.categoria.nombre }}
                </span>
                <span class="meta-item">
                    <i class='bx bxs-star'></i> {{ promedio }} / 5
                </span>
            </div>
        </div>

        <div class="recipe-hero-img">
            <img src="/receta/obtenerImagen/{{ receta.idReceta }}" alt="{{ receta.nombre }}">
            
            <div class="recipe-badges">
                {% if receta.dificultad == 'Fácil' %}
                    <span class="badge bg-facil">Fácil</span>
                {% elif receta.dificultad == 'Media' %}
                    <span class="badge bg-media">Media</span>
                {% else %}
                    <span class="badge bg-dificil">Difícil</span>
                {% endif %}
            </div>
        </div>

        <div class="recipe-description">
            <p>"{{ receta.descripcion }}"</p>
        </div>

        <div class="recipe-content">
            
            <div class="ingredients-box">
                <h3><i class='bx bxs-basket'></i> Ingredientes</h3>
                <div class="ingredients-list">
                    {{ receta.ingredientes }}
                </div>
            </div>

            <div class="preparation-box">
                <h3><i class='bx bxs-hot'></i> Preparación</h3>
                <div class="preparation-text">
                    {{ receta.preparacion }}
                </div>
            </div>

        </div>

        <div class="rating-section">
            {% if current_user.is_authenticated %}
                
                <div class="global-rating-box">
                    <h3>Tu calificación general</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Esta calificación aparecerá en todos tus comentarios.</p>
                    
                    <form method="POST" id="formRating">
                        <input type="hidden" name="accion" value="actualizar_rating">
                        
                        <div class="star-widget">
                            <input type="radio" name="calificacion" id="rate-5" value="5" {% if mi_rating == 5 %}checked{% endif %} onchange="this.form.submit()">
                            <label for="rate-5" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-4" value="4" {% if mi_rating == 4 %}checked{% endif %} onchange="this.form.submit()">
                            <label for="rate-4" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-3" value="3" {% if mi_rating == 3 %}checked{% endif %} onchange="this.form.submit()">
                            <label for="rate-3" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-2" value="2" {% if mi_rating == 2 %}checked{% endif %} onchange="this.form.submit()">
                            <label for="rate-2" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-1" value="1" {% if mi_rating == 1 %}checked{% endif %} onchange="this.form.submit()">
                            <label for="rate-1" class="bx bxs-star"></label>
                        </div>
                    </form>
                </div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

                <div class="nuevo-comentario-box" style="margin-top: 30px;">
                    <form method="POST" class="rating-form">
                        <input type="hidden" name="accion" value="nuevo_comentario">
                        
                        <div class="comment-box">
                            <label for="nuevo_comentario">
                                {% if mis_entradas %}
                                    ¿Algo más que agregar?
                                {% else %}
                                    Escribe tu opinión sobre la receta:
                                {% endif %}
                            </label>
                            <textarea name="comentario" id="nuevo_comentario" placeholder="Escribe aquí..." required></textarea>
                        </div>

                        <button type="submit">Publicar comentario</button>
                    </form>
                </div>

            {% else %}
                <div class="login-prompt">
                    <p>¿Cocinaste esto? <a href="{{ url_for('login') }}">Inicia sesión</a> para calificar y comentar.</p>
                </div>
                
                <div class="stars-display">
                    <span>Promedio actual:</span>
                    {% for i in range(1, 6) %}
                        {% if i <= promedio|int %}
                            <i class="bx bxs-star"></i>
                        {% elif i - 0.5 <= promedio and i > promedio|int %}
                            <i class="bx bxs-star-half"></i>
                        {% else %}
                            <i class="bx bx-star"></i>
                        {% endif %}
                    {% endfor %}
                    ({{ promedio }})
                </div>
            {% endif %}
        </div>

        <div class="comments-list-section">
            <h3><i class='bx bx-message-square-dots'></i> Comentarios de la comunidad</h3>
            
            {% if receta.calificaciones|length > 0 %}
                <div class="comments-grid">
                    {% for c in receta.calificaciones %}
                        {% if c.comentario != none %}
                        <div class="comment-card">
                            <div class="comment-avatar">
                                <img src="/usuarios/obtenerImagen/{{ c.usuario.idUsuario }}" alt="Usuario">
                            </div>
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">
                                        {{ c.usuario.nombre_apellido }}
                                        {% if current_user.is_authenticated and current_user.is_admin() %}
                                            <span>(Admin)</span>
                                        {% endif %}
                                    </span>
                                    
                                    <div class="comment-stars">
                                        {% for i in range(1, 6) %}
                                            {% if i <= c.calificacion %}
                                                <i class="bx bxs-star"></i>
                                            {% else %}
                                                <i class="bx bx-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>

                                    {% if current_user.is_authenticated and (current_user.is_admin() or c.idUsuario == current_user.idUsuario) %}
                                    <div class="cat-botones">
                                        {% if c.idUsuario == current_user.idUsuario %}
                                            <button type="button" class="cat-btnEdit"
                                                onclick="abrirModalEditar(event, '{{ c.idCalificacion }}', '{{ c.comentario }}')">
                                                <i class='bx bx-edit'></i>
                                            </button>
                                        {% else %}
                                            <a href="{{ url_for('editar_comentario_admin', idCalificacion=c.idCalificacion) }}" class="cat-btnEdit">
                                                <i class='bx bx-edit'></i>
                                            </a>
                                        {% endif %}
                                        
                                        <button type="button" class="cat-btnDelete"
                                            onclick="abrirModalComentario(event, '{{ c.idCalificacion }}', '{{ c.usuario.nombre_apellido }}')">
                                            <i class='bx bxs-trash'></i>
                                        </button>

                                    </div>
                                    {% endif %}

                                </div>
                                <p class="comment-text">"{{ c.comentario }}"</p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-comments">
                    <p>Aún no hay comentarios. ¡Sé el primero en opinar!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="modalConfirmar" class="modal-overlay">
        <div class="modal-contenido">
            <h3>Eliminar Comentario</h3>
            <p>¿Estás seguro de eliminar el comentario de <strong id="nombreUsuarioModal"></strong>?</p>
            <p style="font-size: 0.9rem; color: #666;">Esta acción no se puede deshacer.</p>
            
            <form id="formEliminarComentario" method="POST" action="">
                <div class="modal-botones">
                    <button type="button" id="btnCancelarModal" class="modal-btn modal-btn-cancelar">Cancelar</button>
                    <button type="submit" class="modal-btn modal-btn-eliminar">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditarTexto" class="modal-overlay">
        <div class="modal-contenido">
            <h3>Editar Comentario</h3>
            <form method="POST">
                <input type="hidden" name="accion" value="editar_comentario">
                <input type="hidden" id="idCalificacionEditar" name="idCalificacion">
                
                <div class="input-wrapper" style="margin: 0 0 20px 0;">
                    <textarea name="texto_editado" id="textoEditarArea" style="min-height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 10px; width: 100%;"></textarea>
                </div>

                <div class="modal-botones">
                    <button type="button" onclick="cerrarModalEditar()" class="modal-btn modal-btn-cancelar">Cancelar</button>
                    <button type="submit" class="modal-btn" style="background: var(--primaryColor); color: #fff;">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/ver-receta.js') }}"></script>
    
    <script>
        const modalEdit = document.getElementById('modalEditarTexto');
        const areaTexto = document.getElementById('textoEditarArea');
        const inputId = document.getElementById('idCalificacionEditar');

        function abrirModalEditar(event, id, textoActual) {
            if(event) event.stopPropagation();
            areaTexto.value = textoActual;
            inputId.value = id;
            modalEdit.classList.add('mostrar');
        }

        function cerrarModalEditar() {
            modalEdit.classList.remove('mostrar');
        }

        if (modalEdit) {
            modalEdit.addEventListener('click', (e) => {
                if (e.target === modalEdit) cerrarModalEditar();
            });
        }
    </script>
</main>
{% endblock %}