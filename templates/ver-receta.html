{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ver-receta.css') }}">
{% endblock %}

{% block title %} {{ receta.nombre }} {% endblock %}

{% block content %}
<main>
    <div class="recipe-container">
        
        <div class="recipe-header">
            <h1>{{ receta.nombre }}</h1>
            <div class="recipe-meta">
                <span class="meta-item">
                    <i class='bx bxs-user-circle'></i> {{ receta.usuario.nombre_apellido }}
                </span>
                <span class="meta-item">
                    <i class='bx bxs-category'></i> {{ receta.categoria.nombre }}
                </span>
                <span class="meta-item">
                    <i class='bx bxs-star'></i> {{ promedio }} / 5
                </span>
            </div>
        </div>

        <div class="recipe-hero-img">
            <img src="/receta/obtenerImagen/{{ receta.idReceta }}" alt="{{ receta.nombre }}">
            
            <div class="recipe-badges">
                {% if receta.dificultad == 'Fácil' %}
                    <span class="badge bg-facil">Fácil</span>
                {% elif receta.dificultad == 'Media' %}
                    <span class="badge bg-media">Media</span>
                {% else %}
                    <span class="badge bg-dificil">Difícil</span>
                {% endif %}
            </div>
        </div>

        <div class="recipe-description">
            <p>"{{ receta.descripcion }}"</p>
        </div>

        <div class="recipe-content">
            
            <div class="ingredients-box">
                <h3><i class='bx bxs-basket'></i> Ingredientes</h3>
                <div class="ingredients-list">
                    {{ receta.ingredientes }}
                </div>
            </div>

            <div class="preparation-box">
                <h3><i class='bx bxs-hot'></i> Preparación</h3>
                <div class="preparation-text">
                    {{ receta.preparacion }}
                </div>
            </div>

        </div>

        <div class="rating-section">
            
            {% if calificacion_usuario %}
                <h3>Tu opinión sobre esta receta</h3>
                
                <div class="stars-display" style="margin-bottom: 20px;">
                    <span>Calificaste con:</span>
                    {% for i in range(1, 6) %}
                        {% if i <= calificacion_usuario.calificacion %}
                            <i class="bx bxs-star"></i>
                        {% else %}
                            <i class="bx bx-star"></i>
                        {% endif %}
                    {% endfor %}
                    <span style="font-size: 0.9rem; color: #888;">({{ calificacion_usuario.calificacion }}/5)</span>
                </div>

                <form method="POST" class="rating-form">
                    <input type="hidden" name="calificacion" value="{{ calificacion_usuario.calificacion }}">
                    
                    <div class="comment-box">
                        <label for="comentario">
                            {% if calificacion_usuario.comentario and calificacion_usuario.comentario != 'Sin comentario' %}
                                Edita tu comentario:
                            {% else %}
                                ¿Quieres agregar un comentario a tu calificación?
                            {% endif %}
                        </label>
                        <textarea name="comentario" id="comentario" placeholder="Escribe tu opinión aquí...">{% if calificacion_usuario.comentario != 'Sin comentario' %}{{ calificacion_usuario.comentario }}{% endif %}</textarea>
                    </div>

                    <button type="submit">
                        {% if calificacion_usuario.comentario and calificacion_usuario.comentario != 'Sin comentario' %}
                            Actualizar comentario
                        {% else %}
                            Publicar comentario
                        {% endif %}
                    </button>
                </form>

            {% else %}
            
                <h3>Deja tu opinión</h3>
                <div class="stars-display">
                    <span>Promedio de usuarios:</span>
                    {% for i in range(1, 6) %}
                        {% if i <= promedio|int %}
                            <i class="bx bxs-star"></i>
                        {% elif i - 0.5 <= promedio and i > promedio|int %}
                            <i class="bx bxs-star-half"></i>
                        {% else %}
                            <i class="bx bx-star"></i>
                        {% endif %}
                    {% endfor %}
                    ({{ promedio }})
                </div>

                {% if current_user.is_authenticated %}
                    <form method="POST" class="rating-form">
                        <p>Califica esta receta:</p>
                        
                        <div class="star-widget">
                            <input type="radio" name="calificacion" id="rate-5" value="5">
                            <label for="rate-5" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-4" value="4">
                            <label for="rate-4" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-3" value="3">
                            <label for="rate-3" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-2" value="2">
                            <label for="rate-2" class="bx bxs-star"></label>
                            
                            <input type="radio" name="calificacion" id="rate-1" value="1" required>
                            <label for="rate-1" class="bx bxs-star"></label>
                        </div>
            
                        <div class="comment-box">
                            <label for="comentario">Tu comentario (opcional):</label>
                            <textarea name="comentario" id="comentario" placeholder="¿Qué te pareció el sabor? ¿Fue fácil de preparar?"></textarea>
                        </div>
            
                        <button type="submit">Publicar reseña</button>
                    </form>
                {% else %}
                    <div class="login-prompt">
                        <p>¿Cocinaste esto? <a href="{{ url_for('login') }}">Inicia sesión</a> para guardar tu calificación.</p>
                    </div>
                {% endif %}
            
            {% endif %}
        </div>

        <div class="comments-list-section">
            <h3><i class='bx bx-message-square-dots'></i> Comentarios de la comunidad</h3>
            
            {% if receta.calificaciones|length > 0 %}
                <div class="comments-grid">
                    {% for c in receta.calificaciones %}
                        {% if c.comentario != none %}
                        <div class="comment-card">
                            <div class="comment-avatar">
                                <img src="/usuarios/obtenerImagen/{{ c.usuario.idUsuario }}" alt="Foto de {{ c.usuario.nombre }}">
                            </div>
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">
                                        {{ c.usuario.nombre_apellido }}
                                        {% if current_user.is_authenticated and current_user.is_admin() %}
                                            <span style="font-size: 0.8rem; color: red; margin-left: 5px;">(Admin Mode)</span>
                                        {% endif %}
                                    </span>
                                    
                                    <div class="comment-stars">
                                        {% for i in range(1, 6) %}
                                            {% if i <= c.calificacion %}
                                                <i class="bx bxs-star"></i>
                                            {% else %}
                                                <i class="bx bx-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>

                                    {% if current_user.is_authenticated and ( current_user.is_admin() or c.idUsuario==current_user.idUsuario) %}
                                    <div class="cat-botones">
                                        {% if c.idUsuario == current_user.idUsuario %}
                                            <a href="#comentario" class="cat-btnEdit" onclick="document.getElementById('comentario').focus()">
                                                <i class='bx bx-edit'></i>
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('editar_comentario_admin', idCalificacion=c.idCalificacion) }}" class="cat-btnEdit">
                                                <i class='bx bx-edit'></i>
                                            </a>
                                        {% endif %}
                                        
                                        <button type="button" class="cat-btnDelete" 
                                            onclick="abrirModalComentario(event, '{{ c.idCalificacion }}', '{{ c.usuario.nombre_apellido }}')">
                                            <i class='bx bxs-trash'></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                
                                    <div class="comment-stars">
                                        </div>
                                </div>
                                <p class="comment-text">"{{ c.comentario }}"</p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-comments">
                    <p>Aún no hay comentarios. ¡Sé el primero en opinar!</p>
                </div>
            {% endif %}
        </div>

    </div>

    <script src="{{ url_for('static', filename='js/ver-receta.js') }}"></script>
</main>
{% endblock %}